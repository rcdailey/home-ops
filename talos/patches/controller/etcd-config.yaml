# yaml-language-server: $schema=https://schemas.talos.dev/v1alpha1/patch.json
---
# Expose etcd metrics endpoint for Prometheus/VictoriaMetrics scraping
# etcd will listen on 0.0.0.0:2381 for metrics while continuing to serve
# client requests on 127.0.0.1:2379 (secure, localhost-only access)
#
# Enable auto-compaction to prevent excessive database growth and fragmentation
# periodic mode with 24h retention compacts data older than 24 hours every hour
# This prevents fragmentation that causes slow commit durations (>250ms threshold)
- op: add
  path: /cluster/etcd/extraArgs
  value:
    listen-metrics-urls: http://0.0.0.0:2381
    auto-compaction-mode: periodic
    auto-compaction-retention: "24h"
