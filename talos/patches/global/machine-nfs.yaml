---
# NFS client mount options configuration
#
# Using nconnect=4 for optimal balance between throughput and connection stability.
# Higher values (8, 16) cause NFS client request distribution imbalance leading to
# connection-specific stalls that manifest as 30-second timeouts.
#
# Industry best practices (NetApp, VMware, Azure, Red Hat KB 6998955):
# - nconnect=4: Optimal for most workloads including streaming
# - nconnect=8: Maximum recommended value
# - nconnect=16: Known to cause performance degradation with sequential I/O
#
# References:
# - https://github.com/siderolabs/talos/issues/6582
# - https://github.com/siderolabs/talos/issues/8862
# - Red Hat KB 6998955 (nconnect performance issues)
machine:
  files:
  # - Noatime doesn't do anything for NFS mounts.
  #   See: https://www.man7.org/linux/man-pages/man5/nfs.5.html
  # - timeo, retrans, hard, proto are redundant: defaults are reasonable
  - content: |
      [NFSMount_Global_Options]
      Nconnect=4
    permissions: 0o644
    path: /etc/nfsmount.conf
    op: overwrite
