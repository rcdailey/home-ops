# yaml-language-server: $schema=https://raw.githubusercontent.com/siderolabs/talos/refs/heads/main/pkg/machinery/config/schemas/config.schema.json
#
# Talos machine configuration template
# Rendered with: just talos::render-config <node>
# Secrets injected via: infisical run --env=prod --path=/bootstrap
#
# Environment variables:
#   From Infisical (/bootstrap): TALOS_* prefixed secrets
#   From talenv.yaml: TALOS_VERSION, KUBERNETES_VERSION
#
# Template variables:
#   node: Node name (passed via -D node=<name>)
#   nodes: Node definitions (from nodes.yaml data file)
---
{% set n = nodes[node] %}
version: v1alpha1
debug: false
persist: true
machine:
  type: {{ "controlplane" if n.controller else "worker" }}
  token: {{ ENV.TALOS_MACHINE_TOKEN }}
  ca:
    crt: {{ ENV.TALOS_MACHINE_CA_CRT }}
    key: {{ ENV.TALOS_MACHINE_CA_KEY if n.controller else '""' }}
  certSANs:
    - 127.0.0.1
    - 192.168.1.70
  kubelet:
    image: ghcr.io/siderolabs/kubelet:{{ ENV.KUBERNETES_VERSION }}
    extraConfig:
      # DRA (Dynamic Resource Allocation) feature gates
      # ResourceHealthStatus: Enables DRA drivers to report device health status
      # and prevents kubelet from losing gRPC connection to DRA drivers after
      # 30 minutes of inactivity (known issue in K8s v1.34.0-v1.34.1).
      # Required for Intel GPU Resource Driver stability.
      featureGates:
        ResourceHealthStatus: true
      serializeImagePulls: false
      volumeStatsAggPeriod: 1m
      # Image garbage collection configuration
      # Addresses imagefs detection failure by using time-based GC (imageMaximumGCAge)
      # combined with aggressive disk-based thresholds as backup
      imageMaximumGCAge: 168h
      imageGCHighThresholdPercent: 50
      imageGCLowThresholdPercent: 20
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - 192.168.1.0/24
    disableManifestsDirectory: true
  network:
    interfaces:
      - interface: bond0
        addresses:
          - {{ n.ip }}/24
        routes:
          - network: 0.0.0.0/0
            gateway: 192.168.1.1
        bond:
          interfaces: []
          deviceSelectors:
            - hardwareAddr: {{ n.mac }}
          mode: active-backup
        mtu: 1500
        dhcp: false
{% if n.controller %}
        vip:
          ip: 192.168.1.70
{% endif %}
  install:
    diskSelector:
      model: {{ n.disk_model }}
{% if n.disk_size is defined %}
      size: "{{ n.disk_size }}"
{% endif %}
    image: factory.talos.dev/metal-installer/{{ ENV.TALOS_SCHEMATIC_ID }}:{{ ENV.TALOS_VERSION }}
    wipe: false
    grubUseUKICmdline: true
  files:
    - content: |-
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
        [plugins."io.containerd.cri.v1.runtime"]
          cdi_spec_dirs = ["/var/cdi/static", "/var/cdi/dynamic"]
          device_ownership_from_security_context = true
      permissions: 0o644
      path: /etc/cri/conf.d/20-customization.part
      op: create
  sysctls:
    fs.inotify.max_user_instances: "8192"
    fs.inotify.max_user_watches: "1048576"
    net.core.rmem_max: "67108864"
    net.core.wmem_max: "67108864"
    net.ipv4.tcp_fastopen: "3"
    net.ipv4.tcp_mtu_probing: "1"
    net.ipv4.tcp_rmem: 4096 262144 67108864
    net.ipv4.tcp_wmem: 4096 262144 67108864
  features:
{% if n.controller %}
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - system-upgrade
{% endif %}
    diskQuotaSupport: true
    kubePrism:
      enabled: true
      port: 7445
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: true
{% if n.controller %}
  nodeLabels:
    node.kubernetes.io/exclude-from-external-load-balancers: ""
{% endif %}
cluster:
  id: {{ ENV.TALOS_CLUSTER_ID }}
  secret: {{ ENV.TALOS_CLUSTER_SECRET }}
  controlPlane:
    endpoint: https://192.168.1.70:6443
  clusterName: home-ops
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.42.0.0/16
    serviceSubnets:
      - 10.43.0.0/16
  token: {{ ENV.TALOS_BOOTSTRAP_TOKEN }}
  ca:
    crt: {{ ENV.TALOS_K8S_CA_CRT }}
    key: {{ ENV.TALOS_K8S_CA_KEY if n.controller else '""' }}
{% if n.controller %}
  secretboxEncryptionSecret: {{ ENV.TALOS_SECRETBOX_ENCRYPTION_SECRET }}
  aggregatorCA:
    crt: {{ ENV.TALOS_K8S_AGGREGATOR_CA_CRT }}
    key: {{ ENV.TALOS_K8S_AGGREGATOR_CA_KEY }}
  serviceAccount:
    key: {{ ENV.TALOS_K8S_SERVICEACCOUNT_KEY }}
  apiServer:
    image: registry.k8s.io/kube-apiserver:{{ ENV.KUBERNETES_VERSION }}
    extraArgs:
      # https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/
      enable-aggregator-routing: "true"
      # Enable MutatingAdmissionPolicy for VolSync NFS volume injection
      # Requires both feature gate and runtime-config (beta feature in K8s 1.34)
      feature-gates: MutatingAdmissionPolicy=true
      runtime-config: admissionregistration.k8s.io/v1beta1=true
    certSANs:
      - 127.0.0.1
      - 192.168.1.70
    auditPolicy:
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        - level: Metadata
  controllerManager:
    image: registry.k8s.io/kube-controller-manager:{{ ENV.KUBERNETES_VERSION }}
    extraArgs:
      bind-address: 0.0.0.0
      # Lower threshold for terminated pod garbage collection (default: 12500)
      # Cleans up Error/Completed pods more frequently to prevent accumulation
      terminated-pod-gc-threshold: "100"
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:{{ ENV.KUBERNETES_VERSION }}
  scheduler:
    image: registry.k8s.io/kube-scheduler:{{ ENV.KUBERNETES_VERSION }}
    extraArgs:
      bind-address: 0.0.0.0
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: true
      service: {}
  etcd:
    ca:
      crt: {{ ENV.TALOS_ETCD_CA_CRT }}
      key: {{ ENV.TALOS_ETCD_CA_KEY }}
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381
      # Enable auto-compaction to prevent excessive database growth and fragmentation
      # periodic mode with 24h retention compacts data older than 24 hours every hour
      auto-compaction-mode: periodic
      auto-compaction-retention: 24h
    advertisedSubnets:
      - 192.168.1.0/24
  coreDNS:
    disabled: true
  allowSchedulingOnControlPlanes: true
{% else %}
  # Worker nodes only need minimal cluster config
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: true
      service: {}
{% endif %}
---
apiVersion: v1alpha1
kind: HostnameConfig
auto: "off"
hostname: {{ node }}
---
apiVersion: v1alpha1
kind: ResolverConfig
nameservers:
  - address: 1.1.1.1
  - address: 1.0.0.1
searchDomains:
  disableDefault: true
---
apiVersion: v1alpha1
kind: TimeSyncConfig
ntp:
  servers:
    - 162.159.200.1
    - 162.159.200.123
