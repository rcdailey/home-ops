# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/v1/secret.json
---
apiVersion: v1
kind: Secret
metadata:
  name: ${APP}-volsync-secret
type: Opaque
stringData:
  # Kopia repository password - each app gets unique repo
  KOPIA_PASSWORD: ${APP}-volsync-backup-password
  # S3 access credentials
  AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
  AWS_DEFAULT_REGION: ${S3_REGION}
  # Kopia S3 configuration
  # HISTORICAL CONTEXT - CRITICAL FOR FUTURE DEBUGGING:
  # - Initial config used KOPIA_S3_BUCKET + KOPIA_S3_PREFIX (Sept 29 21:47)
  # - Changed to KOPIA_REPOSITORY URL format (Sept 29 22:47)
  # - Added trailing slash to KOPIA_REPOSITORY (Oct 1 - attempt 1)
  # - ROOT CAUSE: VolSync's Kopia mover container has custom entrypoint script that
  #   STRIPS TRAILING SLASHES from KOPIA_REPOSITORY URLs ("Removed trailing slash
  #   from S3 prefix for consistency" in container logs)
  # - Without trailing slash: Kopia treats prefix as object name prefix (radarr*)
  #   causing collisions with other apps (radarr-4k_log_* files in bucket root)
  # - With trailing slash (stripped by container): Same collision issue persists
  # - SOLUTION: Use separate KOPIA_S3_BUCKET + KOPIA_S3_PREFIX variables instead
  #   of combined KOPIA_REPOSITORY URL. The container doesn't strip trailing slashes
  #   from KOPIA_S3_PREFIX, allowing proper directory-style isolation per Kopia docs:
  #   "Put trailing slash (/) if you want to use prefix as directory"
  # - Previous attempts created 4,940+ flat files in bucket root before cleanup
  # - Bucket was emptied on Oct 1 to allow fresh repository initialization
  #
  # CRITICAL: VolSync 0.16.8 requires BOTH configuration methods:
  # 1. KOPIA_REPOSITORY - Required for secret validation (perfectra1n/volsync mover.go:360)
  # 2. Individual S3 vars - Actually used by entry.sh for repository connection
  # We provide a minimal KOPIA_REPOSITORY to satisfy validation while relying on
  # KOPIA_S3_PREFIX (which preserves trailing slashes) for proper app isolation
  KOPIA_REPOSITORY: s3://volsync-backups/
  KOPIA_S3_BUCKET: volsync-backups
  KOPIA_S3_PREFIX: ${APP}/
  KOPIA_S3_ENDPOINT: ${S3_ENDPOINT}
  KOPIA_S3_DISABLE_TLS: "true"
