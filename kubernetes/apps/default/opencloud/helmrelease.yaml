---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opencloud
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      app:
        strategy: Recreate
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch
        containers:
          app:
            image:
              repository: docker.io/opencloudeu/opencloud-rolling
              tag: 3.7.0@sha256:7bd41ba329a29869227804875f62cb59f23ed9178ae3b6be36f3a7f0e514077e
            command: ["/bin/sh", "-c", "opencloud init || true; opencloud server"]
            env:
              # Disable internal IDP, use external OIDC (Authelia)
              OC_EXCLUDE_RUN_SERVICES: idp
              OC_OIDC_ISSUER: https://auth.${SECRET_DOMAIN}
              WEB_OIDC_CLIENT_ID: web
              WEB_OPTION_OPENID_CONNECT_AUTHORITY: https://auth.${SECRET_DOMAIN}
              # Request groups scope for role assignment (default: "openid profile email")
              WEB_OIDC_SCOPE: "openid profile email groups"
              PROXY_CSP_CONFIG_FILE_LOCATION: /etc/opencloud/csp.yaml
              PROXY_OIDC_REWRITE_WELLKNOWN: "true"
              # Authelia uses opaque access tokens, not JWTs - skip verification but still call UserInfo
              PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD: none
              PROXY_OIDC_SKIP_USER_INFO: "false"
              PROXY_AUTOPROVISION_ACCOUNTS: "true"
              # Role assignment via OIDC groups claim (configured in proxy.yaml)
              PROXY_ROLE_ASSIGNMENT_DRIVER: oidc
              # Authelia sends groups in 'groups' claim, not default 'roles' claim
              PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM: groups
              # Use 'sub' claim for stable user identification (immutable per OIDC spec)
              # Source: opencloud-eu/opencloud services/proxy/README.md warns against mutable claims
              PROXY_USER_OIDC_CLAIM: sub
              PROXY_AUTOPROVISION_CLAIM_USERNAME: preferred_username
              PROXY_USER_CS3_CLAIM: username
              GRAPH_ASSIGN_DEFAULT_USER_ROLE: "false"
              GRAPH_USERNAME_MATCH: none
              # General settings
              OC_INSECURE: true
              OC_URL: https://opencloud.${SECRET_DOMAIN}
              PROXY_TLS: false
              OC_LOG_LEVEL: debug
              # Disable OpenCloud Mesh federation (not federating with other instances)
              OC_ENABLE_OCM: false
              # Disable default app/settings assignments for OIDC-provisioned users
              SETTINGS_SETUP_DEFAULT_ASSIGNMENTS: "false"
              # Storage configuration
              # decomposed is production-ready for NFS, posix is experimental
              STORAGE_USERS_DRIVER: decomposed
              # Use NATS JetStream for ID caching (faster lookups)
              STORAGE_USERS_ID_CACHE_STORE: nats-js-kv
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 1Gi
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
    service:
      app:
        controller: app
        ports:
          http:
            port: 9200
    route:
      app:
        parentRefs:
        - name: external
          namespace: network
          sectionName: https
        hostnames:
        - opencloud.${SECRET_DOMAIN}
        rules:
        - backendRefs:
          - name: opencloud
            port: 9200
    persistence:
      data:
        type: nfs
        server: 192.168.1.58
        path: /mnt/user/opencloud
        globalMounts:
        - path: /var/lib/opencloud
      config:
        type: persistentVolumeClaim
        existingClaim: opencloud
        globalMounts:
        - path: /etc/opencloud
      proxy-config:
        type: configMap
        name: opencloud-config
        globalMounts:
        - path: /etc/opencloud/proxy.yaml
          subPath: proxy.yaml
          readOnly: true
        - path: /etc/opencloud/csp.yaml
          subPath: csp.yaml
          readOnly: true
      tmpfs:
        type: emptyDir
        globalMounts:
        - path: /tmp
