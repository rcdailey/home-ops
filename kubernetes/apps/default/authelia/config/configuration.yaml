# yaml-language-server: $schema=https://www.authelia.com/schemas/v4.39/json-schema/configuration.json
---
# Authelia configuration for domain-level SSO
# This configuration provides unified authentication across *.${SECRET_DOMAIN}
# solving the multiple login issue from per-app Authentik providers

theme: dark

server:
  address: tcp://0.0.0.0:9091

log:
  level: info

identity_validation:
  reset_password:
    jwt_lifespan: 5m

totp:
  issuer: ${SECRET_DOMAIN}
  period: 30
  skew: 1

# LDAP authentication via LLDAP
# Password provided via AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD environment variable
authentication_backend:
  ldap:
    implementation: lldap
    address: ldap://lldap.default:3890
    base_dn: dc=dailey,dc=app
    user: uid=admin,ou=people,dc=dailey,dc=app

# Domain-level access control - single login for all apps
access_control:
  default_policy: deny
  rules:
  # Allow API endpoints without authentication
  # Required for: qBittorrent API, Radarr/Sonarr API clients, etc.
  - domain: "*.${SECRET_DOMAIN}"
    policy: bypass
    resources:
    - "^/api.*$"

  # Require two-factor authentication for all apps under domain
  # This creates unified SSO experience across all subdomains
  - domain: "*.${SECRET_DOMAIN}"
    policy: two_factor

# Session configuration with Redis storage
# Domain-level cookies enable SSO across all *.${SECRET_DOMAIN} apps
# Note: session.secret is provided via AUTHELIA_SESSION_SECRET environment variable
session:
  cookies:
  - domain: ${SECRET_DOMAIN}
    authelia_url: https://auth.${SECRET_DOMAIN}
    default_redirection_url: https://home.${SECRET_DOMAIN}
  redis:
    host: authelia-redis.default
    port: 6379

# Rate limiting for brute force protection
regulation:
  max_retries: 4
  find_time: 2m
  ban_time: 5m

# Local SQLite storage
# Note: storage.encryption_key is provided via AUTHELIA_STORAGE_ENCRYPTION_KEY environment variable
storage:
  local:
    path: /config/db.sqlite3

# SMTP notifier for email notifications (2FA, password reset, etc.)
# Configuration provided via AUTHELIA_NOTIFIER_SMTP_* environment variables
notifier:
  disable_startup_check: true
  smtp:
    startup_check_address: test@authelia.com
    subject: "[Authelia] {title}"
