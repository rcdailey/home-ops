# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app renovate-ce
spec:
  interval: 30m
  chart:
    spec:
      chart: mend-renovate-ce
      version: 12.0.0
      sourceRef:
        kind: HelmRepository
        name: mend-renovate-ce
      interval: 30m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    image:
      repository: ghcr.io/mend/renovate-ce
      tag: 11.5.0
      useFull: true
      pullPolicy: IfNotPresent

    fullnameOverride: *app

    # Deployment strategy for RWO volume
    strategy:
      type: Recreate

    renovate:
      existingSecret: renovate-ce-secret

      mendRnvAcceptTos: y
      mendRnvPlatform: github
      mendRnvEndpoint: https://api.github.com/
      mendRnvApiEnabled: true
      mendRnvApiEnableReporting: true
      mendRnvWebhookSkipDisabledRepoJobs: true
      mendRnvSqliteFilePath: /db/renovate-ce.sqlite
      mendRnvLogHistoryDir: /db/logs
      mendRnvLogHistoryTTLDays: 30

      config: |
        module.exports = {
          platform: 'github',
          endpoint: 'https://api.github.com/',
          onboarding: true,
          requireConfig: 'optional',
          gitAuthor: 'Renovate Bot <renovate[bot]@users.noreply.github.com>',
          repositories: [],
          autodiscover: true,
          autodiscoverFilter: ['rcdailey/*'],
        };

      logLevel: info
      logFormat: json

    cachePersistence:
      enabled: false

    disableCacheVolume: false

    service:
      type: ClusterIP
      ports:
        http: 8080

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
        - ALL

    annotations:
      reloader.stakater.com/auto: "true"

    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 2Gi

    livenessProbe:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 2
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      httpGet:
        path: /health
        port: http
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    extraVolumes:
    - name: db
      persistentVolumeClaim:
        claimName: renovate-ce

    extraVolumeMounts:
    - name: db
      mountPath: /db
