---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plex
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      plex:
        strategy: Recreate
        annotations:
          reloader.stakater.com/auto: "true"

        pod:
          securityContext:
            fsGroup: 1000
            fsGroupChangePolicy: "OnRootMismatch"
          resourceClaims:
          - name: gpu
            resourceClaimTemplateName: plex

        containers:
          app:
            image:
              repository: ghcr.io/home-operations/plex
              tag: 1.42.2.10156
            env:
              TZ: America/Chicago
              PLEX_ADVERTISE_URL: http://192.168.50.100:32400,https://plex.${SECRET_DOMAIN}:443
              PLEX_PREFERENCE_1: "secureConnections=1"

              # Leave this out for now; I want to make sure this isn't functionally necessary.
              # I prefer to not use it since it introduces a security issue.
              # PLEX_NO_AUTH_NETWORKS: 192.168.1.0/24

              # Covers 192.168.0.0-31.255, excludes 192.168.50.0/24 (Kubernetes BGP/LoadBalancer
              # subnet) to prevent plex.{SECRET_DOMAIN} from being treated as local network traffic
              PLEX_PREFERENCE_2: "LanNetworksBandwidth=192.168.0.0/19"

            # TODO: Disabled probes for easier debugging; reenable these later
            # probes:
            #   liveness: &probes
            #     enabled: true
            #     custom: true
            #     spec:
            #       httpGet:
            #         path: /identity
            #         port: 32400
            #       initialDelaySeconds: 0
            #       periodSeconds: 10
            #       timeoutSeconds: 1
            #       failureThreshold: 3
            #   readiness: *probes
            #   startup:
            #     enabled: true
            #     spec:
            #       failureThreshold: 30
            #       periodSeconds: 10

            resources:
              requests:
                cpu: 1000m
                memory: 4Gi
              limits:
                memory: 16Gi
              claims:
              - name: gpu

            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop: ["ALL"]

          # TEMPORARY: Testing if Vector sidecar contributes to Ceph write
          # amplification and stuck terminating pods. Disabled for baseline testing.
          # vector-sidecar:
          #   image:
          #     repository: timberio/vector
          #     tag: 0.50.0-alpine
          #   env:
          #     TZ: America/Chicago
          #     VECTOR_CONFIG_PATH: /etc/vector/vector.yaml
          #     POD_NAME:
          #       valueFrom:
          #         fieldRef:
          #           fieldPath: metadata.name
          #     NODE_NAME:
          #       valueFrom:
          #         fieldRef:
          #           fieldPath: spec.nodeName
          #   resources:
          #     requests:
          #       cpu: 10m
          #       memory: 32Mi
          #     limits:
          #       cpu: 200m
          #       memory: 256Mi
          #   securityContext:
          #     runAsUser: 1000
          #     runAsGroup: 1000
          #     runAsNonRoot: true
          #     allowPrivilegeEscalation: false
          #     readOnlyRootFilesystem: true
          #     capabilities:
          #       drop: ["ALL"]

    persistence:
      config:
        existingClaim: plex-config
        advancedMounts:
          plex:
            app:
            - path: /config
              # vector-sidecar:
              # - path: /config
              #   readOnly: true

      config-cache:
        existingClaim: plex-cache
        advancedMounts:
          plex:
            app:
            - path: /config/Library/Application Support/Plex Media Server/Cache

      media:
        type: nfs
        server: 192.168.1.58
        path: /mnt/user/media
        advancedMounts:
          plex:
            app:
            - path: /media
              readOnly: true

      logs:
        existingClaim: plex-logs
        advancedMounts:
          plex:
            app:
            - path: /config/Library/Application Support/Plex Media Server/Logs
              # vector-sidecar:
              # - path: /config/Library/Application Support/Plex Media Server/Logs
              #   readOnly: true

      tmpfs:
        type: emptyDir
        advancedMounts:
          plex:
            app:
            - path: /tmp
              subPath: tmp
            - path: /transcode
              subPath: transcode

      # vector-config:
      #   type: configMap
      #   name: plex-vector-config
      #   advancedMounts:
      #     plex:
      #       vector-sidecar:
      #       - path: /etc/vector
      #         readOnly: true

      # vector-data:
      #   existingClaim: plex-vector-data
      #   advancedMounts:
      #     plex:
      #       vector-sidecar:
      #       - path: /var/lib/vector

    route:
      app:
        hostnames:
        - plex.${SECRET_DOMAIN}
        parentRefs:
        - name: external
          namespace: network
          sectionName: https
        rules:
        - # Ref: https://forums.plex.tv/t/external-srt-subtitles-are-not-working-w-reverse-proxy/886540
          backendRefs:
          - name: plex
            port: 32400
          filters:
          - type: RequestHeaderModifier
            requestHeaderModifier:
              remove:
              - Range
          matches:
          - path:
              type: PathPrefix
              value: /library/streams
        - backendRefs:
          - name: plex
            port: 32400

    service:
      app:
        controller: plex
        ports:
          http:
            port: 32400
