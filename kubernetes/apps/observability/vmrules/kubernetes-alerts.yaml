---
# yaml-language-server: $schema=https://raw.githubusercontent.com/victoriametrics/operator/master/config/crd/bases/operator.victoriametrics.com_vmrules.yaml
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: kubernetes-alerts
spec:
  groups:
  - name: kubernetes-pods
    interval: 30s
    rules:
    - alert: PodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total[5m]) > 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container }}) is restarting {{ $value }} times / 5 minutes"

    - alert: PodNotReady
      expr: |
        kube_pod_status_ready{condition="false"} == 1
        and on (namespace, pod) kube_pod_status_phase{phase!~"Succeeded|Failed"} == 1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} not ready"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready state for longer than 15 minutes"

    - alert: DeploymentReplicasMismatch
      expr: kube_deployment_spec_replicas != kube_deployment_status_available_replicas
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} replica mismatch"
        description: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has {{ $labels.spec_replicas }} desired but {{ $labels.available_replicas }} available replicas"

  - name: kubernetes-resources
    interval: 30s
    rules:
    - alert: ContainerHighCPU
      expr: |
        rate(container_cpu_usage_seconds_total{container!="POD",container!=""}[5m]) > 0.8
        and on (namespace, pod, container) (
          container_spec_cpu_quota / container_spec_cpu_period > 0
        )
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "High CPU usage in container {{ $labels.container }}"
        description: "Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} is using {{ $value | humanizePercentage }} CPU"

    - alert: ContainerHighMemory
      expr: |
        (container_memory_working_set_bytes{container!="POD",container!=""} / container_spec_memory_limit_bytes > 0.9)
        and (container_spec_memory_limit_bytes > 0)
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage in container {{ $labels.container }}"
        description: "Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} is using {{ $value | humanizePercentage }} of its memory limit"

    - alert: PersistentVolumeClaimPending
      expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is pending"
        description: "PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} has been pending for more than 10 minutes"
