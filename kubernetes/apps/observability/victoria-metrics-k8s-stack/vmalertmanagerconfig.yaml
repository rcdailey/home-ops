---
# yaml-language-server: $schema=https://raw.githubusercontent.com/victoriametrics/operator/master/config/crd/bases/operator.victoriametrics.com_vmalertmanagerconfigs.yaml
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAlertmanagerConfig
metadata:
  name: pushover-alerts
spec:
  route:
    receiver: pushover
    group_by: [alertname, cluster, service]
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
    routes:
    - receiver: blackhole
      matchers:
      - alertname = "CephMonClockSkew"
    - receiver: blackhole
      matchers:
      - alertname = "CephNodeNetworkPacketErrors"
    - receiver: blackhole
      matchers:
      - alertname = "CephNodeInconsistentMTU"
    - receiver: gatus-heartbeat
      matchers:
      - alertname = "Watchdog"
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 5m
    - receiver: blackhole
      matchers:
      - severity = "none"
    - receiver: pushover-critical
      matchers:
      - severity = "critical"
      group_wait: 10s
      repeat_interval: 5m
    - receiver: pushover
      matchers:
      - severity =~ "warning|info"

  inhibit_rules:
  - source_matchers:
    - severity = "critical"
    target_matchers:
    - severity = "warning"
    equal: [alertname, namespace]

  receivers:
  - name: blackhole

  - name: gatus-heartbeat
    webhook_configs:
    - url: http://gatus.observability/api/v1/endpoints/_Heartbeat/external?success=true
      http_config:
        bearer_token_secret:
          name: gatus-secret
          key: GATUS_HEARTBEAT_TOKEN

  - name: pushover
    pushover_configs:
    - user_key:
        name: pushover-secret
        key: PUSHOVER_USER_KEY
      token:
        name: pushover-secret
        key: PUSHOVER_APP_TOKEN
      send_resolved: true
      html: true
      priority: |-
        {{ if eq .Status "firing" }}1{{ else }}0{{ end }}
      title: >-
        [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
      message: |-
        {{- range .Alerts }}
          {{- if ne .Annotations.description "" }}
            {{ .Annotations.description }}
          {{- else if ne .Annotations.summary "" }}
            {{ .Annotations.summary }}
          {{- else if ne .Annotations.message "" }}
            {{ .Annotations.message }}
          {{- else }}
            Alert description not available
          {{- end }}
          {{- if gt (len .Labels.SortedPairs) 0 }}
            <small>
              {{- range .Labels.SortedPairs }}
                <b>{{ .Name }}:</b> {{ .Value }}
              {{- end }}
            </small>
          {{- end }}
        {{- end }}

  - name: pushover-critical
    pushover_configs:
    - user_key:
        name: pushover-secret
        key: PUSHOVER_USER_KEY
      token:
        name: pushover-secret
        key: PUSHOVER_APP_TOKEN
      send_resolved: true
      html: true
      priority: "2"
      retry: "60s"
      expire: "3600s"
      title: >-
        [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
      message: |-
        {{- range .Alerts }}
          {{- if ne .Annotations.description "" }}
            {{ .Annotations.description }}
          {{- else if ne .Annotations.summary "" }}
            {{ .Annotations.summary }}
          {{- else if ne .Annotations.message "" }}
            {{ .Annotations.message }}
          {{- else }}
            Alert description not available
          {{- end }}
          {{- if gt (len .Labels.SortedPairs) 0 }}
            <small>
              {{- range .Labels.SortedPairs }}
                <b>{{ .Name }}:</b> {{ .Value }}
              {{- end }}
            </small>
          {{- end }}
        {{- end }}
