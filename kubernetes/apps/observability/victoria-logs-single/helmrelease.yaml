---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-logs-single
spec:
  interval: 30m
  timeout: 20m
  chart:
    spec:
      chart: victoria-logs-single
      version: 0.11.8
      sourceRef:
        kind: HelmRepository
        name: victoriametrics
        namespace: flux-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    server:
      enabled: true
      # Override the service name to match expected naming convention
      fullnameOverride: "victoria-logs-single"
      retentionPeriod: 14
      extraArgs:
        envflag.enable: true
        envflag.prefix: VM_
        loggerFormat: json
        httpListenAddr: :9428
        http.shutdownDelay: 15s

      persistentVolume:
        enabled: true
        storageClassName: ceph-block
        accessModes:
        - ReadWriteOnce
        size: 25Gi
        mountPath: /storage

      resources:
        limits:
          memory: 1Gi
        requests:
          cpu: 50m
          memory: 256Mi

      service:
        type: ClusterIP
        servicePort: 9428
        targetPort: http

      # Security context
      securityContext:
        enabled: true
        allowPrivilegeEscalation: false
        capabilities:
          drop:
          - ALL
        readOnlyRootFilesystem: true

      podSecurityContext:
        enabled: true
        fsGroup: 2000
        runAsNonRoot: true
        runAsUser: 1000

    # Enable Vector log collection
    vector:
      enabled: true
      resources:
        limits:
          memory: 512Mi
        requests:
          cpu: 20m
          memory: 128Mi

      customConfig:
        data_dir: /vector-data-dir
        api:
          enabled: false
          address: 0.0.0.0:8686
          playground: true

        # Global configuration for memory optimization
        expire_metrics_secs: 600

        sources:
          k8s:
            type: kubernetes_logs
            # Allowlist approach: Only collect from specified namespaces
            include_paths_glob_patterns:
            - "**/default/**"
            # Memory optimization: Use API server cache instead of etcd
            use_apiserver_cache: true
          internal_metrics:
            type: internal_metrics

        transforms:
          parser:
            type: remap
            inputs: [k8s]
            source: |
              .log = parse_json(.message) ?? .message
              del(.message)

        sinks:
          exporter:
            type: prometheus_exporter
            address: 0.0.0.0:9090
            inputs: [internal_metrics]

          vlogs:
            type: elasticsearch
            inputs: [parser]
            mode: bulk
            api_version: v8
            compression: gzip
            healthcheck:
              enabled: false
            # Buffer configuration for memory optimization
            buffer:
              type: memory
              max_events: 10000
              when_full: drop_newest
            # Batch settings for memory efficiency
            batch:
              max_bytes: 1048576 # 1MB
              timeout_secs: 5
            request:
              headers:
                VL-Time-Field: timestamp
                VL-Stream-Fields: stream,kubernetes.pod_name,kubernetes.container_name,kubernetes.pod_namespace
                VL-Msg-Field: message,msg,_msg,log.msg,log.message,log
                AccountID: "0"
                ProjectID: "0"
            endpoints:
            - http://victoria-logs-single:9428/insert/elasticsearch/

    # Service monitor for metrics
    serviceMonitor:
      enabled: true
      extraLabels: {}
      annotations: {}
      targetPort: http
