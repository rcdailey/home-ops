{
  "id": null,
  "title": "PVC Capacity Overview",
  "tags": ["kubernetes", "storage"],
  "style": "dark",
  "timezone": "browser",
  "editable": true,
  "hideControls": false,
  "graphTooltip": 1,
  "panels": [
    {
      "id": 1,
      "title": "Top 10 Fullest PVCs",
      "type": "bargauge",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "topk(10, (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100)",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 60 },
              { "color": "red", "value": 90 }
            ]
          }
        }
      },
      "options": {
        "orientation": "horizontal",
        "displayMode": "gradient",
        "showUnfilled": true
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 }
    },
    {
      "id": 2,
      "title": "All PVCs - Capacity and Usage",
      "type": "table",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "kubelet_volume_stats_capacity_bytes",
          "format": "table",
          "instant": true,
          "refId": "Capacity"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "kubelet_volume_stats_used_bytes",
          "format": "table",
          "instant": true,
          "refId": "Used"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "(kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100",
          "format": "table",
          "instant": true,
          "refId": "UsagePercent"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "kubelet_volume_stats_capacity_bytes - kubelet_volume_stats_used_bytes",
          "format": "table",
          "instant": true,
          "refId": "Available"
        }
      ],
      "transformations": [
        {
          "id": "merge"
        },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time": true,
              "job": true,
              "instance": true,
              "metrics_path": true,
              "__name__": true
            },
            "indexByName": {
              "namespace": 0,
              "persistentvolumeclaim": 1,
              "Value #Capacity": 2,
              "Value #Used": 3,
              "Value #UsagePercent": 4,
              "Value #Available": 5
            },
            "renameByName": {
              "namespace": "Namespace",
              "persistentvolumeclaim": "PVC Name",
              "Value #Capacity": "Total Capacity",
              "Value #Used": "Used Space",
              "Value #UsagePercent": "Usage %",
              "Value #Available": "Available Space"
            }
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto"
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Total Capacity"
            },
            "properties": [
              {
                "id": "unit",
                "value": "bytes"
              },
              {
                "id": "custom.displayMode",
                "value": "auto"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Used Space"
            },
            "properties": [
              {
                "id": "unit",
                "value": "bytes"
              },
              {
                "id": "custom.displayMode",
                "value": "auto"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Available Space"
            },
            "properties": [
              {
                "id": "unit",
                "value": "bytes"
              },
              {
                "id": "custom.displayMode",
                "value": "auto"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Usage %"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "custom.displayMode",
                "value": "color-background"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "yellow", "value": 60 },
                    { "color": "red", "value": 90 }
                  ]
                }
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "displayName": "Usage %",
            "desc": true
          }
        ]
      },
      "gridPos": { "h": 16, "w": 24, "x": 0, "y": 8 }
    },
    {
      "id": 3,
      "title": "RBD Read IOPS",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) rate(ceph_rbd_read_ops[5m]))",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "iops",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 }
    },
    {
      "id": 4,
      "title": "RBD Write IOPS",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) rate(ceph_rbd_write_ops[5m]))",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "iops",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 }
    },
    {
      "id": 5,
      "title": "RBD Read Throughput",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) rate(ceph_rbd_read_bytes[5m]))",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "binBps",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 32 }
    },
    {
      "id": 6,
      "title": "RBD Write Throughput",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) rate(ceph_rbd_write_bytes[5m]))",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "binBps",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 32 }
    },
    {
      "id": 7,
      "title": "RBD Read Latency",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) (rate(ceph_rbd_read_latency_sum[5m]) / on (image) rate(ceph_rbd_read_latency_count[5m]))) or max by (namespace, persistentvolumeclaim) (kube_persistentvolumeclaim_info * 0)",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ns",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 40 }
    },
    {
      "id": 8,
      "title": "RBD Write Latency",
      "type": "timeseries",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "VictoriaMetrics"
          },
          "expr": "max by (namespace, persistentvolumeclaim) (label_replace(kube_persistentvolumeclaim_info, \"persistentvolume\", \"$1\", \"volumename\", \"(.*)\") * on (persistentvolume) group_left(image) label_replace(kube_persistentvolume_info{csi_driver=\"rook-ceph.rbd.csi.ceph.com\"}, \"image\", \"$1\", \"csi_volume_handle\", \"(.*)\") * on (image) group_right(namespace, persistentvolumeclaim) (rate(ceph_rbd_write_latency_sum[5m]) / on (image) rate(ceph_rbd_write_latency_count[5m]))) or max by (namespace, persistentvolumeclaim) (kube_persistentvolumeclaim_info * 0)",
          "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ns",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true,
          "calcs": ["mean", "max"]
        }
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 40 }
    }
  ],
  "time": {
    "from": "now-5m",
    "to": "now"
  },
  "timepicker": {},
  "refresh": "30s",
  "schemaVersion": 41,
  "version": 1
}
