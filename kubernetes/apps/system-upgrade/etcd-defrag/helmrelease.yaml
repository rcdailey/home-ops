---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: etcd-defrag
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    serviceAccount:
      etcd-defrag: {}

    controllers:
      etcd-defrag:
        type: cronjob
        serviceAccount:
          identifier: etcd-defrag
        cronjob:
          # Run daily at 2 AM
          schedule: "0 2 * * *"
          backoffLimit: 0
          concurrencyPolicy: Forbid
          successfulJobsHistory: 3
          failedJobsHistory: 3
          ttlSecondsAfterFinished: 86400

        annotations:
          reloader.stakater.com/auto: "true"

        pod:
          restartPolicy: Never
          # Run on control plane nodes where etcd is located
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
          # Use host network to access etcd on localhost
          hostNetwork: true
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            fsGroup: 0
            runAsNonRoot: false

        initContainers:
          fetch-certs:
            image:
              repository: alpine
              tag: latest
            command:
            - sh
            - -c
            - |
              set -ex

              TALOS_VERSION=$(grep '^VERSION_ID=' /host/etc/os-release | cut -d'=' -f2 | tr -d '"')

              apk add --no-cache curl
              curl -fsSL -o /usr/local/bin/talosctl "https://github.com/siderolabs/talos/releases/download/${TALOS_VERSION}/talosctl-linux-amd64"
              chmod +x /usr/local/bin/talosctl

              echo "Listing /system/secrets recursively:"
              talosctl --nodes 127.0.0.1 ls -r /system/secrets/ || true

              talosctl --nodes 127.0.0.1 read /system/secrets/etcd/ca.crt > /certs/ca.crt
              talosctl --nodes 127.0.0.1 read /system/secrets/etcd/admin.crt > /certs/admin.crt
              talosctl --nodes 127.0.0.1 read /system/secrets/etcd/admin.key > /certs/admin.key

              echo "Verifying certificate/key pair:"
              apk add --no-cache openssl
              openssl x509 -in /certs/admin.crt -noout -modulus | openssl md5
              openssl ec -in /certs/admin.key -noout -modulus 2>/dev/null | openssl md5
              echo "The above two MD5 hashes must match for certs to work"

              ls -la /certs/
            env:
              TALOSCONFIG: /var/run/secrets/talos.dev/config
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                - ALL

        containers:
          app:
            image:
              repository: ghcr.io/ahrtr/etcd-defrag
              tag: v0.36.0
            args:
            - --endpoints=https://127.0.0.1:2379
            - --cluster
            - --cacert=/certs/ca.crt
            - --cert=/certs/admin.crt
            - --key=/certs/admin.key
            - --move-leader
            - --wait-between-defrags=30s
            - --etcd-storage-quota-bytes=2147483648
            - --auto-disalarm
            - --disalarm-threshold=0.8
            env:
              TZ: America/Chicago
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                memory: 64Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL

    persistence:
      talos-secrets:
        type: secret
        name: etcd-defrag
        advancedMounts:
          etcd-defrag:
            fetch-certs:
            - path: /var/run/secrets/talos.dev
              readOnly: true

      certs:
        type: emptyDir
        advancedMounts:
          etcd-defrag:
            fetch-certs:
            - path: /certs
            app:
            - path: /certs
              readOnly: true

      tmp:
        type: emptyDir
        advancedMounts:
          etcd-defrag:
            app:
            - path: /tmp

      host-etc:
        type: hostPath
        hostPath: /etc
        advancedMounts:
          etcd-defrag:
            fetch-certs:
            - path: /host/etc
              readOnly: true
