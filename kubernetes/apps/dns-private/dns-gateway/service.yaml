---
# yaml-language-server: $schema=https://kubernetesjsonschema.dev/v1.14.0/service-v1.json
# TODO: WORKAROUND for Cilium L2 announcements + externalTrafficPolicy: Local incompatibility
# Issue: https://github.com/cilium/cilium/issues/27800
#
# Current: Using externalTrafficPolicy: Cluster + DSR/Geneve to preserve source IP
# Future: When Cilium properly supports L2 + Local, revert to externalTrafficPolicy: Local
#
apiVersion: v1
kind: Service
metadata:
  name: dns-gateway
  namespace: dns-private
  labels:
    # For IP pool selector - marks this as infrastructure proxy service
    app.kubernetes.io/component: proxy
  annotations:
    lbipam.cilium.io/ips: "192.168.1.71"
spec:
  type: LoadBalancer
  # Changed from Local to Cluster for issue #27800 workaround
  # DSR + Geneve tunneling preserves source IP with Cluster policy
  externalTrafficPolicy: Cluster
  selector:
    # For finding backend DNS pods to route traffic to
    app.kubernetes.io/component: dns-server
    app.kubernetes.io/controller: adguard-home
  ports:
  - name: dns-tcp
    port: 53
    protocol: TCP
    targetPort: 5353
  - name: dns-udp
    port: 53
    protocol: UDP
    targetPort: 5353
