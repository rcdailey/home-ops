---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:

  add-secret:
    desc: Add a secret to Infisical with automatic folder creation
    silent: true
    vars:
      CLI_ARGS: '{{.CLI_ARGS}}'
    cmd: |
      # Parse CLI_ARGS into array
      eval "set -- {{.CLI_ARGS}}"

      if [ $# -ne 2 ]; then
        echo "Usage: task infisical:add-secret -- /path/to/secret value"
        echo "Example: task infisical:add-secret -- /media/sonarr/api-key \"value123\""
        exit 1
      fi

      FULL_PATH="$1"
      SECRET_VALUE="$2"

      # Extract secret name (last segment) and folder path (everything before)
      SECRET_NAME=$(basename "$FULL_PATH")
      FOLDER_PATH=$(dirname "$FULL_PATH")

      # Normalize paths: folder ops need no leading slash, secret ops need leading slash
      FOLDER_PATH="${FOLDER_PATH#/}"
      FOLDER_PATH="${FOLDER_PATH%/}"
      SECRET_PATH="/$FOLDER_PATH"

      echo "Creating folder hierarchy for: $FOLDER_PATH"

      # Build path incrementally and create folders
      CURRENT_PATH=""
      OLDIFS="$IFS"
      IFS='/'

      for SEGMENT in $FOLDER_PATH; do
        # Skip empty segments (from leading /)
        if [ -z "$SEGMENT" ]; then
          continue
        fi

        PARENT_PATH="$CURRENT_PATH"
        if [ -z "$CURRENT_PATH" ]; then
          CURRENT_PATH="$SEGMENT"
        else
          CURRENT_PATH="$CURRENT_PATH/$SEGMENT"
        fi

        # Check if folder exists by querying parent and looking for this segment
        # (folders get returns subfolders, not the folder itself)
        PARENT_FOLDERS=$(infisical secrets folders get --path "$PARENT_PATH" --silent 2>/dev/null)
        FOLDER_EXISTS=$(echo "$PARENT_FOLDERS" | rg -q "â”‚ $SEGMENT " && echo "yes" || echo "no")

        if [ "$FOLDER_EXISTS" = "no" ]; then
          echo "Creating folder: $CURRENT_PATH (parent: $PARENT_PATH, name: $SEGMENT)"
          # Omit --path for root-level folders
          if [ -z "$PARENT_PATH" ]; then
            CREATE_CMD="infisical secrets folders create --name \"$SEGMENT\""
          else
            CREATE_CMD="infisical secrets folders create --name \"$SEGMENT\" --path \"$PARENT_PATH\""
          fi
          if ! CREATE_OUTPUT=$(eval "$CREATE_CMD" 2>&1); then
            echo "Failed to create folder: $CURRENT_PATH" >&2
            echo "Error: $CREATE_OUTPUT" >&2
            IFS="$OLDIFS"
            exit 1
          fi
        else
          echo "Folder exists: $CURRENT_PATH"
        fi
      done

      IFS="$OLDIFS"

      # Set the secret (secret operations need leading slash)
      echo "Setting secret: $SECRET_NAME at path: $SECRET_PATH"
      if ! infisical secrets set "$SECRET_NAME=$SECRET_VALUE" --path "$SECRET_PATH"; then
        echo "Failed to set secret: $SECRET_NAME"
        exit 1
      fi

      echo "Successfully created secret: $SECRET_NAME at path: $SECRET_PATH"
    preconditions:
      - which infisical
